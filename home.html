<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zephyrçš„ä¸‹è½½ç«™</title>
    <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
    
    <script>
        // ===== å¼ºåˆ¶éªŒè¯ç³»ç»Ÿ =====
        (function() {
            console.log('ğŸ” Zephyrä¸‹è½½ç«™ - å¼ºåˆ¶éªŒè¯å¯åŠ¨');
            
            // ç«‹å³æ¸…ç©ºé¡µé¢ï¼Œæ˜¾ç¤ºéªŒè¯ç•Œé¢
            document.body.innerHTML = `
                <div style="
                    position: fixed;
                    top: 0;
                    left: 0;
                    right: 0;
                    bottom: 0;
                    background: #0d1117;
                    display: flex;
                    flex-direction: column;
                    justify-content: center;
                    align-items: center;
                    z-index: 99999;
                    color: #c9d1d9;
                    text-align: center;
                    padding: 40px 20px;
                    font-family: -apple-system, BlinkMacSystemFont, sans-serif;
                ">
                    <div style="font-size: 4rem; margin-bottom: 20px;">ğŸ”’</div>
                    <h1 style="color: #58a6ff; margin: 0 0 15px 0; font-size: 2rem;">è®¿é—®éªŒè¯</h1>
                    <p id="verifyMessage" style="margin: 0 0 40px 0; font-size: 1.1rem; max-width: 500px;">
                        æ­£åœ¨éªŒè¯è®¿é—®æƒé™ï¼Œè¯·ç¨å€™...
                    </p>
                    
                    <div style="width: 300px; height: 8px; background: #30363d; border-radius: 4px; overflow: hidden; margin-bottom: 30px;">
                        <div id="verifyProgress" style="height: 100%; background: #238636; width: 0%; transition: width 0.3s ease;"></div>
                    </div>
                    
                    <div id="verifyActions" style="display: none;">
                        <button onclick="window.location.href='index.html'" style="
                            padding: 12px 30px;
                            background: #238636;
                            color: white;
                            border: none;
                            border-radius: 8px;
                            cursor: pointer;
                            font-weight: bold;
                            font-size: 1rem;
                            transition: background 0.2s;
                        ">
                            å‰å¾€éªŒè¯é¡µé¢
                        </button>
                        <p style="margin-top: 20px; color: #8b949e; font-size: 0.9rem;">
                            å¦‚æœæœªè‡ªåŠ¨è·³è½¬ï¼Œè¯·ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®
                        </p>
                    </div>
                </div>
            `;
            
            // ä¸¥æ ¼çš„éªŒè¯å‡½æ•°
            function strictVerify() {
                console.log('ğŸ” æ‰§è¡Œä¸¥æ ¼éªŒè¯æ£€æŸ¥...');
                
                // 1. å¿…é¡»æ£€æŸ¥ sessionStorage ä»¤ç‰Œ
                const token = sessionStorage.getItem('auth_token');
                if (!token || token.trim() === '') {
                    console.log('âŒ æœªæ‰¾åˆ°éªŒè¯ä»¤ç‰Œ');
                    return { valid: false, reason: 'no_token' };
                }
                
                try {
                    // 2. è§£ç ä»¤ç‰Œ
                    const decoded = atob(token);
                    console.log('ä»¤ç‰Œè§£ç :', decoded.substring(0, 50) + '...');
                    
                    // 3. æ£€æŸ¥æ ¼å¼: æ—¶é—´æˆ³_éšæœºå­—ç¬¦ä¸²
                    const parts = decoded.split('_');
                    if (parts.length < 2) {
                        console.log('âŒ ä»¤ç‰Œæ ¼å¼é”™è¯¯');
                        return { valid: false, reason: 'bad_format' };
                    }
                    
                    // 4. éªŒè¯æ—¶é—´æˆ³
                    const timestamp = parseInt(parts[0]);
                    if (isNaN(timestamp)) {
                        console.log('âŒ æ— æ•ˆçš„æ—¶é—´æˆ³');
                        return { valid: false, reason: 'bad_timestamp' };
                    }
                    
                    // 5. æ£€æŸ¥æœ‰æ•ˆæœŸ (10åˆ†é’Ÿ)
                    const now = Date.now();
                    const age = now - timestamp;
                    const maxAge = 10 * 60 * 1000; // 10åˆ†é’Ÿ
                    
                    console.log(`ä»¤ç‰Œä¿¡æ¯: åˆ›å»ºäº ${new Date(timestamp).toLocaleTimeString()}, å¹´é¾„ ${Math.round(age/1000)}ç§’`);
                    
                    if (age > maxAge) {
                        console.log(`âŒ ä»¤ç‰Œå·²è¿‡æœŸ (${Math.round(age/1000)}ç§’ > ${maxAge/1000}ç§’)`);
                        // æ¸…é™¤è¿‡æœŸä»¤ç‰Œ
                        sessionStorage.removeItem('auth_token');
                        return { valid: false, reason: 'expired' };
                    }
                    
                    if (age < 0) {
                        console.log('âŒ æœªæ¥æ—¶é—´æˆ³');
                        return { valid: false, reason: 'future_timestamp' };
                    }
                    
                    console.log(`âœ… ä»¤ç‰ŒéªŒè¯é€šè¿‡ (${Math.round(age/1000)}ç§’å‰)`);
                    return { valid: true, age: age };
                    
                } catch (error) {
                    console.log('âŒ ä»¤ç‰Œè§£ç å¤±è´¥:', error);
                    sessionStorage.removeItem('auth_token');
                    return { valid: false, reason: 'decode_error' };
                }
            }
            
            // è¿›åº¦æ¡åŠ¨ç”»
            let progress = 0;
            const progressBar = document.getElementById('verifyProgress');
            const verifyMessage = document.getElementById('verifyMessage');
            const verifyActions = document.getElementById('verifyActions');
            
            // éªŒè¯å®šæ—¶å™¨
            const verifyTimer = setInterval(() => {
                progress += 5;
                if (progressBar) {
                    progressBar.style.width = progress + '%';
                }
                
                if (progress >= 100) {
                    clearInterval(verifyTimer);
                    
                    // æ‰§è¡ŒéªŒè¯
                    const result = strictVerify();
                    
                    if (result.valid) {
                        // éªŒè¯æˆåŠŸ
                        verifyMessage.textContent = 'âœ… éªŒè¯é€šè¿‡ï¼Œæ­£åœ¨åŠ è½½ä¸‹è½½ç«™...';
                        if (progressBar) progressBar.style.background = '#58a6ff';
                        
                        // æ˜¾ç¤ºçœŸå®é¡µé¢å†…å®¹
                        setTimeout(() => {
                            document.body.innerHTML = ORIGINAL_PAGE_CONTENT;
                            // åˆå§‹åŒ–é¡µé¢åŠŸèƒ½
                            if (typeof window.initDownloadPage === 'function') {
                                setTimeout(window.initDownloadPage, 100);
                            }
                        }, 500);
                        
                    } else {
                        // éªŒè¯å¤±è´¥
                        verifyMessage.innerHTML = 'âŒ éœ€è¦éªŒè¯è®¿é—®æƒé™<br><small style="color:#8b949e;font-size:0.9em;">è¯·å®ŒæˆäººæœºéªŒè¯åè®¿é—®</small>';
                        if (progressBar) {
                            progressBar.style.background = '#da3633';
                            progressBar.style.width = '100%';
                        }
                        
                        // æ˜¾ç¤ºæ“ä½œæŒ‰é’®
                        verifyActions.style.display = 'block';
                        
                        // 5ç§’åè‡ªåŠ¨è·³è½¬
                        setTimeout(() => {
                            // æ¸…ç†å¯èƒ½çš„æ®‹ç•™æ•°æ®
                            sessionStorage.removeItem('auth_token');
                            // å¼ºåˆ¶è·³è½¬åˆ°éªŒè¯é¡µ
                            window.location.href = 'index.html?from=' + encodeURIComponent(window.location.pathname);
                        }, 5000);
                    }
                }
            }, 50);
            
            // åŸå§‹é¡µé¢å†…å®¹ (ç”±è„šæœ¬å¡«å……)
            const ORIGINAL_PAGE_CONTENT = `
                <!-- ä¸‹è½½ç«™é¡µé¢å†…å®¹ -->
                <div class="page-container">
                    <div class="page-header">
                        <h1>ğŸµ Zephyrçš„Phigrosèµ„æºä¸‹è½½ç«™</h1>
                        <p class="page-subtitle">ä½¿ç”¨JSDelivr CDNï¼Œæ”¯æŒè·¨åŸŸä¸‹è½½</p>
                    </div>
                    
                    <div class="search-container">
                        <input type="text" id="searchInput" class="search-input" placeholder="æœç´¢æ­Œæ›²ID (ä¾‹å¦‚: é’èŠ½)...">
                    </div>
                    
                    <div class="songs-list" id="songsList">
<div class='no-results'>âŒ æœªæ‰¾åˆ°ä»»ä½•èµ„æºæ–‡ä»¶</div>
                    </div>
                </div>
                
                <style>
                    /* é¡µé¢æ ·å¼ */
                    * {
                        margin: 0;
                        padding: 0;
                        box-sizing: border-box;
                    }
                    
                    body {
                        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
                        background: #0d1117;
                        color: #c9d1d9;
                        line-height: 1.6;
                    }
                    
                    .page-container {
                        max-width: 1200px;
                        margin: 0 auto;
                        padding: 20px;
                    }
                    
                    .page-header {
                        text-align: center;
                        margin-bottom: 40px;
                        padding-bottom: 30px;
                        border-bottom: 1px solid #30363d;
                    }
                    
                    .page-header h1 {
                        color: #58a6ff;
                        font-size: 2.5rem;
                        margin-bottom: 10px;
                    }
                    
                    .page-subtitle {
                        color: #8b949e;
                        font-size: 1rem;
                    }
                    
                    .search-container {
                        margin-bottom: 30px;
                    }
                    
                    .search-input {
                        width: 100%;
                        padding: 15px 20px;
                        font-size: 1rem;
                        background: #161b22;
                        border: 1px solid #30363d;
                        border-radius: 10px;
                        color: #c9d1d9;
                        transition: all 0.2s;
                    }
                    
                    .search-input:focus {
                        outline: none;
                        border-color: #58a6ff;
                        box-shadow: 0 0 0 2px rgba(88, 166, 255, 0.2);
                    }
                    
                    .search-input::placeholder {
                        color: #6e7681;
                    }
                    
                    /* æ­Œæ›²å¡ç‰‡æ ·å¼ */
                    .song-card {
                        background: #161b22;
                        border: 1px solid #30363d;
                        border-radius: 12px;
                        margin-bottom: 25px;
                        overflow: hidden;
                        transition: transform 0.2s, box-shadow 0.2s;
                    }
                    
                    .song-card:hover {
                        transform: translateY(-2px);
                        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
                    }
                    
                    .song-header {
                        background: #21262d;
                        padding: 20px;
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        border-bottom: 1px solid #30363d;
                    }
                    
                    .song-title {
                        color: #58a6ff;
                        font-size: 1.3rem;
                        font-weight: 600;
                        word-break: break-all;
                    }
                    
                    .song-controls {
                        display: flex;
                        align-items: center;
                        gap: 20px;
                    }
                    
                    .file-count {
                        color: #8b949e;
                        font-size: 0.9rem;
                        min-width: 100px;
                        text-align: right;
                    }
                    
                    .download-btn {
                        background: #238636;
                        color: white;
                        border: none;
                        padding: 10px 20px;
                        border-radius: 8px;
                        cursor: pointer;
                        font-weight: 600;
                        font-size: 0.95rem;
                        transition: background 0.2s;
                        display: flex;
                        align-items: center;
                        gap: 8px;
                    }
                    
                    .download-btn:hover {
                        background: #2ea043;
                    }
                    
                    .download-btn:disabled {
                        background: #30363d;
                        cursor: not-allowed;
                        opacity: 0.6;
                    }
                    
                    .song-content {
                        display: flex;
                        padding: 25px;
                        gap: 30px;
                    }
                    
                    @media (max-width: 768px) {
                        .song-content {
                            flex-direction: column;
                        }
                    }
                    
                    .preview-area {
                        flex: 0 0 250px;
                    }
                    
                    .preview-img {
                        width: 100%;
                        height: 180px;
                        object-fit: cover;
                        border-radius: 8px;
                        border: 1px solid #30363d;
                    }
                    
                    .no-preview {
                        width: 100%;
                        height: 180px;
                        background: #21262d;
                        border-radius: 8px;
                        border: 1px dashed #30363d;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        color: #8b949e;
                    }
                    
                    .files-area {
                        flex: 1;
                    }
                    
                    .select-all {
                        color: #58a6ff;
                        cursor: pointer;
                        margin-bottom: 20px;
                        padding: 8px 0;
                        display: inline-block;
                        font-weight: 500;
                        user-select: none;
                    }
                    
                    .select-all:hover {
                        text-decoration: underline;
                    }
                    
                    .file-list {
                        max-height: 350px;
                        overflow-y: auto;
                        padding-right: 10px;
                    }
                    
                    .file-list::-webkit-scrollbar {
                        width: 8px;
                    }
                    
                    .file-list::-webkit-scrollbar-track {
                        background: #161b22;
                        border-radius: 4px;
                    }
                    
                    .file-list::-webkit-scrollbar-thumb {
                        background: #30363d;
                        border-radius: 4px;
                    }
                    
                    .file-list::-webkit-scrollbar-thumb:hover {
                        background: #484f58;
                    }
                    
                    /* æ–‡ä»¶é¡¹æ ·å¼ */
                    .file-item {
                        display: flex;
                        align-items: center;
                        background: #0d1117;
                        padding: 14px 18px;
                        margin-bottom: 10px;
                        border-radius: 8px;
                        border: 1px solid #30363d;
                        cursor: pointer;
                        transition: all 0.2s;
                        user-select: none;
                    }
                    
                    .file-item:hover {
                        background: #21262d;
                        border-color: #58a6ff;
                    }
                    
                    /* å¤é€‰æ¡† - ç¡®ä¿å¯è§ */
                    .file-checkbox {
                        width: 20px;
                        height: 20px;
                        margin-right: 15px;
                        cursor: pointer;
                        accent-color: #238636;
                        flex-shrink: 0;
                    }
                    
                    /* æ–‡ä»¶æ ‡ç­¾ */
                    .file-tag {
                        font-size: 0.8rem;
                        padding: 4px 10px;
                        border-radius: 4px;
                        color: white;
                        margin-right: 12px;
                        font-weight: 600;
                        min-width: 55px;
                        text-align: center;
                        flex-shrink: 0;
                    }
                    
                    .file-tag-ill {
                        background: #da3633;
                    }
                    
                    .file-tag-audio {
                        background: #1f6feb;
                    }
                    
                    .file-tag-chart {
                        background: #238636;
                    }
                    
                    .file-name {
                        flex: 1;
                        overflow: hidden;
                        text-overflow: ellipsis;
                        white-space: nowrap;
                        color: #c9d1d9;
                    }
                    
                    /* éš¾åº¦æ ‡ç­¾ */
                    .difficulty {
                        font-size: 0.75rem;
                        padding: 3px 8px;
                        border-radius: 4px;
                        margin-left: 10px;
                        font-weight: bold;
                        color: white;
                        flex-shrink: 0;
                    }
                    
                    .diff-ez { background: #238636; }
                    .diff-hd { background: #da3633; }
                    .diff-in { background: #8957e5; }
                    .diff-at { background: #f0883e; }
                    .diff-sp { background: #9e6a03; }
                    
                    /* æ— ç»“æœæç¤º */
                    .no-results {
                        text-align: center;
                        padding: 60px 20px;
                        color: #8b949e;
                        font-size: 1.1rem;
                        background: #161b22;
                        border-radius: 12px;
                        border: 1px solid #30363d;
                    }
                    
                    /* å“åº”å¼è°ƒæ•´ */
                    @media (max-width: 768px) {
                        .page-container {
                            padding: 15px;
                        }
                        
                        .page-header h1 {
                            font-size: 1.8rem;
                        }
                        
                        .song-header {
                            flex-direction: column;
                            align-items: flex-start;
                            gap: 15px;
                        }
                        
                        .song-controls {
                            width: 100%;
                            justify-content: space-between;
                        }
                        
                        .preview-area {
                            flex: none;
                            width: 100%;
                        }
                        
                        .preview-img,
                        .no-preview {
                            height: 200px;
                        }
                    }
                    
                    @media (max-width: 480px) {
                        .song-content {
                            padding: 20px;
                        }
                        
                        .file-item {
                            padding: 12px 15px;
                            flex-wrap: wrap;
                            gap: 10px;
                        }
                        
                        .file-checkbox {
                            order: 1;
                        }
                        
                        .file-tag {
                            order: 2;
                        }
                        
                        .file-name {
                            order: 3;
                            width: 100%;
                            margin-top: 5px;
                        }
                        
                        .difficulty {
                            order: 4;
                            margin-left: auto;
                        }
                    }
                </style>
            `;
        })();
    </script>
</head>
<body>
    <!-- é¡µé¢å†…å®¹ç”±JavaScriptåŠ¨æ€åŠ è½½ -->
    
    <script>
        // ===== é¡µé¢åŠŸèƒ½åˆå§‹åŒ– =====
        window.initDownloadPage = function() {
            console.log('ğŸš€ åˆå§‹åŒ–ä¸‹è½½é¡µé¢åŠŸèƒ½');
            
            // 1. æœç´¢åŠŸèƒ½
            const searchInput = document.getElementById('searchInput');
            if (searchInput) {
                searchInput.addEventListener('input', function() {
                    const searchTerm = this.value.toLowerCase().trim();
                    const songCards = document.querySelectorAll('.song-card');
                    
                    songCards.forEach(card => {
                        const songId = card.getAttribute('data-song-id').toLowerCase();
                        if (searchTerm === '' || songId.includes(searchTerm)) {
                            card.style.display = '';
                        } else {
                            card.style.display = 'none';
                        }
                    });
                });
            }
            
            // 2. åˆå§‹åŒ–æ–‡ä»¶è®¡æ•°
            updateAllFileCounts();
            
            // 3. ç‚¹å‡»æ–‡ä»¶é¡¹åˆ‡æ¢å¤é€‰æ¡†
            document.addEventListener('click', function(event) {
                const fileItem = event.target.closest('.file-item');
                if (fileItem && !event.target.classList.contains('file-checkbox')) {
                    const checkbox = fileItem.querySelector('.file-checkbox');
                    if (checkbox) {
                        checkbox.checked = !checkbox.checked;
                        const songId = fileItem.closest('.song-card').getAttribute('data-song-id');
                        updateFileCount(songId);
                    }
                }
            });
            
            // 4. ç›‘å¬å¤é€‰æ¡†å˜åŒ–
            document.addEventListener('change', function(event) {
                if (event.target.classList.contains('file-checkbox')) {
                    const songId = event.target.closest('.song-card').getAttribute('data-song-id');
                    updateFileCount(songId);
                }
            });
            
            console.log('âœ… é¡µé¢åŠŸèƒ½åˆå§‹åŒ–å®Œæˆ');
        };
        
        // æ›´æ–°å•ä¸ªæ­Œæ›²çš„æ–‡ä»¶è®¡æ•°
        function updateFileCount(songId) {
            const fileList = document.getElementById('files-' + songId);
            if (!fileList) return;
            
            const checkboxes = fileList.querySelectorAll('.file-checkbox');
            const checkedCount = Array.from(checkboxes).filter(cb => cb.checked).length;
            const totalCount = checkboxes.length;
            
            const countElement = document.getElementById('count-' + songId);
            if (countElement) {
                countElement.textContent = checkedCount + '/' + totalCount + ' é€‰ä¸­';
            }
        }
        
        // æ›´æ–°æ‰€æœ‰æ­Œæ›²çš„æ–‡ä»¶è®¡æ•°
        function updateAllFileCounts() {
            document.querySelectorAll('.song-card').forEach(card => {
                const songId = card.getAttribute('data-song-id');
                updateFileCount(songId);
            });
        }
        
        // å…¨é€‰/å–æ¶ˆå…¨é€‰
        window.toggleAllFiles = function(songId) {
            const fileList = document.getElementById('files-' + songId);
            if (!fileList) return;
            
            const checkboxes = fileList.querySelectorAll('.file-checkbox');
            const allChecked = Array.from(checkboxes).every(cb => cb.checked);
            
            checkboxes.forEach(checkbox => {
                checkbox.checked = !allChecked;
            });
            
            updateFileCount(songId);
        };
        
        // ä¸‹è½½æ­Œæ›²æ–‡ä»¶
        window.downloadSong = async function(songId) {
            const fileList = document.getElementById('files-' + songId);
            if (!fileList) return;
            
            const checkboxes = fileList.querySelectorAll('.file-checkbox:checked');
            if (checkboxes.length === 0) {
                alert('è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªæ–‡ä»¶');
                return;
            }
            
            const button = document.querySelector(`.song-card[data-song-id="${songId}"] .download-btn`);
            if (button) {
                button.disabled = true;
                button.innerHTML = 'â³ æ‰“åŒ…ä¸­...';
            }
            
            try {
                const zip = new JSZip();
                const files = Array.from(checkboxes).map(cb => ({
                    url: cb.dataset.url,
                    name: cb.dataset.name
                }));
                
                let processed = 0;
                for (const file of files) {
                    try {
                        const response = await fetch(file.url);
                        if (response.ok) {
                            const blob = await response.blob();
                            zip.file(file.name, blob);
                        }
                        processed++;
                    } catch (error) {
                        console.error('ä¸‹è½½æ–‡ä»¶å¤±è´¥:', file.name, error);
                    }
                }
                
                if (Object.keys(zip.files).length === 0) {
                    throw new Error('æ²¡æœ‰æˆåŠŸä¸‹è½½ä»»ä½•æ–‡ä»¶');
                }
                
                const content = await zip.generateAsync({ type: 'blob' });
                const downloadUrl = URL.createObjectURL(content);
                const link = document.createElement('a');
                link.href = downloadUrl;
                link.download = songId + '_resources_' + Date.now() + '.zip';
                
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                // æ¸…ç†URLå¯¹è±¡
                setTimeout(() => URL.revokeObjectURL(downloadUrl), 100);
                
                if (button) {
                    button.innerHTML = 'âœ… ä¸‹è½½å®Œæˆ';
                    setTimeout(() => {
                        button.disabled = false;
                        button.innerHTML = 'ğŸ“¦ æ‰“åŒ…ä¸‹è½½';
                    }, 2000);
                }
                
            } catch (error) {
                console.error('æ‰“åŒ…ä¸‹è½½å¤±è´¥:', error);
                alert('ä¸‹è½½å¤±è´¥: ' + error.message);
                
                if (button) {
                    button.disabled = false;
                    button.innerHTML = 'ğŸ“¦ æ‰“åŒ…ä¸‹è½½';
                }
            }
        };
        
        // è‡ªåŠ¨åˆå§‹åŒ–
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', function() {
                if (typeof window.initDownloadPage === 'function') {
                    window.initDownloadPage();
                }
            });
        }
    </script>
</body>
</html>
