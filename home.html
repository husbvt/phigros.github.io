  <!DOCTYPE html>
  <html lang="zh-CN">
  <head>
      <meta charset="UTF-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <title>Zephyrçš„ä¸‹è½½ç«™</title>
      <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
      
      <style>
          :root { --blue: #58a6ff; --bg: #0d1117; --card: #161b22; --border: #30363d; --green: #238636; --red: #da3633; }
          body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; background: var(--bg); color: #c9d1d9; margin: 0; padding: 15px; }
          .container { max-width: 900px; margin: auto; padding-bottom: 50px; }
          
          /* åŸºç¡€ç»„ä»¶ */
          h1 { color: var(--blue); text-align: center; margin-bottom: 30px; padding-top: 20px; }
          .search-box { width: 100%; padding: 12px; background: var(--card); border: 1px solid var(--border); color: #fff; border-radius: 8px; margin-bottom: 20px; box-sizing: border-box; font-size: 16px; outline: none; }
          .search-box:focus { border-color: var(--blue); }
          
          /* æ­Œæ›²å¡ç‰‡ */
          .song-card { background: var(--card); border: 1px solid var(--border); border-radius: 12px; margin-bottom: 25px; overflow: hidden; transition: transform 0.2s; }
          .song-card:hover { border-color: #58a6ff; }
          .song-header { background: #21262d; padding: 15px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px; }
          .song-title { font-size: 1.1em; font-weight: bold; color: var(--blue); }
          
          /* å¡ç‰‡å†…å®¹å¸ƒå±€ */
          .song-content { display: flex; flex-direction: column; padding: 15px; gap: 20px; }
          @media (min-width: 600px) { .song-content { flex-direction: row; } }
          
          /* æ›²ç»˜é¢„è§ˆ (å¸¦ç‚¹å‡»æç¤º) */
          .preview-area { flex: 0 0 240px; position: relative; cursor: zoom-in; overflow: hidden; border-radius: 8px; }
          .preview-img { width: 100%; height: 140px; object-fit: cover; border: 1px solid var(--border); background: #21262d; transition: transform 0.3s; }
          .preview-area:hover .preview-img { transform: scale(1.05); }
          .preview-overlay { position: absolute; inset: 0; background: rgba(0,0,0,0.3); display: flex; justify-content: center; align-items: center; opacity: 0; transition: 0.2s; }
          .preview-area:hover .preview-overlay { opacity: 1; }
          
          /* æ–‡ä»¶åˆ—è¡¨ */
          .resource-list { flex: 1; min-width: 0; }
          .file-item { display: flex; align-items: center; background: #0d1117; padding: 10px; margin-bottom: 6px; border-radius: 6px; border: 1px solid var(--border); font-size: 13px; cursor: pointer; user-select: none; transition: 0.2s; }
          .file-item:hover { border-color: var(--blue); background: #1c2128; }
          .file-item input { margin-right: 12px; accent-color: var(--green); transform: scale(1.1); }
          
          /* æ ‡ç­¾ */
          .tag { font-size: 0.75em; padding: 2px 6px; border-radius: 4px; color: #fff; margin-right: 8px; font-weight: bold; min-width: 40px; text-align: center; }
          .tag-ill { background: var(--red); } .tag-audio { background: #1f6feb; } .tag-chart { background: var(--green); }
          .file-name { overflow: hidden; text-overflow: ellipsis; white-space: nowrap; flex: 1; color: #e6edf3; }
          
          /* éš¾åº¦æ ‡ç­¾ */
          .diff { font-size: 0.7em; padding: 1px 5px; border-radius: 3px; margin-left: 5px; font-weight: bold; }
          .diff-EZ { background: var(--green); color: #fff; } .diff-HD { background: #0077b6; color: #fff; }
          .diff-IN { background: #da3633; color: #fff; } .diff-AT { background: #6c757d; color: #fff; } .diff-SP { background: #e9c46a; color: #000; }
  
          /* æŒ‰é’® */
          .btn-zip { background: var(--green); color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-weight: bold; transition: 0.2s; white-space: nowrap; }
          .btn-zip:hover { background: #2ea043; transform: translateY(-1px); }
          .btn-sel { background: transparent; color: var(--blue); border: 1px solid var(--border); padding: 5px 10px; border-radius: 6px; cursor: pointer; font-size: 12px; margin-bottom: 10px; display: inline-block; }
          .btn-sel:hover { border-color: var(--blue); }
  
          /* === ğŸš€ æ ¸å¿ƒæ–°å¢ï¼šå…¨å±ä¸‹è½½è¿›åº¦é¢æ¿æ ·å¼ === */
          #dl-modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 10000; justify-content: center; align-items: center; backdrop-filter: blur(8px); animation: fadeIn 0.2s; }
          .dl-box { background: #161b22; border: 1px solid #30363d; padding: 30px; border-radius: 16px; width: 90%; max-width: 420px; text-align: center; box-shadow: 0 20px 50px rgba(0,0,0,0.6); transform: scale(0.9); animation: popUp 0.3s forwards cubic-bezier(0.175, 0.885, 0.32, 1.275); }
          .dl-title { font-size: 20px; color: #fff; margin-bottom: 25px; font-weight: bold; display: flex; align-items: center; justify-content: center; gap: 10px; }
          .dl-bar-bg { width: 100%; height: 12px; background: #0d1117; border-radius: 6px; overflow: hidden; border: 1px solid #30363d; margin-bottom: 15px; position: relative; }
          .dl-bar-fill { height: 100%; width: 0%; background: linear-gradient(90deg, #238636, #2ea043); transition: width 0.3s ease; box-shadow: 0 0 10px rgba(46, 160, 67, 0.5); }
          .dl-info { font-size: 14px; color: #8b949e; min-height: 20px; margin-bottom: 25px; font-family: monospace; }
          .dl-close { padding: 8px 25px; background: #30363d; color: white; border: none; border-radius: 6px; cursor: pointer; display: none; font-weight: bold; }
          .dl-close:hover { background: #484f58; }
          
          /* === ğŸ–¼ï¸ æ ¸å¿ƒæ–°å¢ï¼šå›¾ç‰‡ç¯ç®± (Lightbox) æ ·å¼ === */
          #lightbox { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 10001; justify-content: center; align-items: center; cursor: zoom-out; animation: fadeIn 0.2s; }
          #lightbox img { max-width: 95%; max-height: 95vh; border-radius: 4px; box-shadow: 0 0 30px rgba(0,0,0,0.5); transform: scale(0.95); animation: zoomIn 0.25s forwards; }
          
          /* åŠ¨ç”»å®šä¹‰ */
          @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
          @keyframes popUp { to { transform: scale(1); } }
          @keyframes zoomIn { to { transform: scale(1); } }
      </style>
  
      <script>
          // ğŸ”’ è®¿é—®æ§åˆ¶é€»è¾‘ (ä¿æŒæœ€ç®€æ ¸å¿ƒä¿æŠ¤)
          (function() {
              function check() {
                  const t = new URLSearchParams(location.search).get('verified') || sessionStorage.getItem('auth_token');
                  if(!t) return false;
                  try { 
                      const ts = parseInt(atob(t).split('_')[0]);
                      return (Date.now() - ts < 600000); // 10åˆ†é’Ÿæœ‰æ•ˆæœŸ
                  } catch(e) { return false; }
              }
              if(!check()) {
                  // éªŒè¯å¤±è´¥ï¼Œæ˜¾ç¤ºé®ç½©
                  document.write('<div style="position:fixed;inset:0;background:#0d1117;color:#c9d1d9;display:flex;flex-direction:column;justify-content:center;align-items:center;z-index:99999"><h2>ğŸ”’ æ­£åœ¨éªŒè¯è®¿é—®æƒé™...</h2><p>å¦‚æœæ²¡æœ‰è·³è½¬ï¼Œè¯·æ‰‹åŠ¨è¿”å›é¦–é¡µã€‚</p></div>');
                  setTimeout(() => location.href = 'index.html', 1500);
              } else {
                  // éªŒè¯é€šè¿‡ï¼Œåˆ·æ–°Tokenæ—¶é—´
                  sessionStorage.setItem('auth_time', Date.now());
              }
          })();
      </script>
  </head>
  <body>
      <div id="dl-modal">
          <div class="dl-box">
              <div class="dl-title">ğŸ“¦ èµ„æºæ‰“åŒ…ä¸‹è½½ä¸­</div>
              <div class="dl-bar-bg"><div id="dl-progress" class="dl-bar-fill"></div></div>
              <div id="dl-text" class="dl-info">å‡†å¤‡å¼€å§‹...</div>
              <button id="dl-close-btn" class="dl-close" onclick="closeDlModal()">å…³é—­çª—å£</button>
          </div>
      </div>
  
      <div id="lightbox" onclick="this.style.display='none'">
          <img id="lb-img" src="" alt="é¢„è§ˆå¤§å›¾">
      </div>
  
      <div class="container">
          <h1>ğŸµ Zephyrçš„ä¸‹è½½ç«™</h1>
          <input type="text" id="search" class="search-box" placeholder="ğŸ” æœç´¢æ­Œæ›² (ID/åç§°)...">
          <div id="list"></div>
      </div>
  EOF
  
  # 2. æ ¸å¿ƒé€»è¾‘ï¼šç”Ÿæˆå¡ç‰‡å¹¶æ³¨å…¥ JS
  cd build_repo
  
  # è·å– ID åˆ—è¡¨
  SONG_IDS=$( ( \
      [ -d "chart" ] && find chart -type d -mindepth 1 -maxdepth 1 | sed 's|chart/||' ; \
      [ -d "music" ] && find music -type f \( -name "*.mp3" -o -name "*.ogg" \) | xargs -I {} basename {} | sed 's/\.[^.]*$//' \
  ) | sed 's/\.[0-9]*$//' | sort -u )
  
  TMP_JS=$(mktemp)
  
  # ç”Ÿæˆæ•°æ® JSON (æ¯”ç›´æ¥ç”ŸæˆHTMLæ›´é«˜æ•ˆ)
  echo "const db = [" > "$TMP_JS"
  
  for id in $SONG_IDS; do
      # æŸ¥æ‰¾æ–‡ä»¶
      ILL=$(find illustration -type f \( -name "${id}.*" -o -name "${id}.*.*" \) 2>/dev/null | head -1)
      AUD=$(find music -type f \( -name "${id}.*" -o -name "${id}.*.*" \) 2>/dev/null | head -1)
      
      # æŸ¥æ‰¾è°±é¢
      CHART_DIR=""
      if [ -d "chart/${id}" ]; then CHART_DIR="chart/${id}"; 
      else POSSIBLE=$(find chart -type d -name "${id}*" | head -1); [ -n "$POSSIBLE" ] && CHART_DIR="$POSSIBLE"; fi
      CHARTS=$( [ -n "$CHART_DIR" ] && find "$CHART_DIR" -type f -name "*.json" 2>/dev/null || echo "" )
      
      [ -z "$ILL$AUD$CHARTS" ] && continue
  
      # æ„å»º JSON å¯¹è±¡
      echo "{id: \"$id\", ill: \"$ILL\", aud: \"$AUD\", charts: [" >> "$TMP_JS"
      for c in $CHARTS; do
          fn=$(basename "$c")
          echo "{path: \"$c\", name: \"$fn\"}," >> "$TMP_JS"
      done
      echo "]}," >> "$TMP_JS"
  done
  
  echo "];" >> "$TMP_JS"
  
  # 3. æ³¨å…¥å‰ç«¯é€»è¾‘ (å«è¿›åº¦æ¡æ§åˆ¶ + ç¯ç®±é€»è¾‘)
  cat >> ../home.html <<EOF2
  <script>
  // æ³¨å…¥æ•°æ®
  $(cat "$TMP_JS")
  
  const BASE_URL = "$BASE_URL";
  
  // åˆå§‹åŒ–æ¸²æŸ“
  const list = document.getElementById('list');
  
  function render() {
      list.innerHTML = db.map(song => {
          let html = \`<div class="song-card" data-id="\${song.id.toLowerCase()}">
              <div class="song-header">
                  <span class="song-title">\${song.id}</span>
                  <button class="btn-zip" onclick="startDownload('\${song.id}')">ğŸ“¦ æ‰“åŒ…ä¸‹è½½</button>
              </div>
              <div class="song-content">
                  <div class="preview-area" onclick="showLightbox('\${song.ill ? BASE_URL + '/' + song.ill : ''}')">
                      \${song.ill 
                          ? \`<img class="preview-img" src="\${BASE_URL}/\${song.ill}" loading="lazy"><div class="preview-overlay"><span style="color:white;font-weight:bold">ğŸ” ç‚¹å‡»æŸ¥çœ‹å¤§å›¾</span></div>\`
                          : '<div class="preview-img" style="display:flex;justify-content:center;align-items:center;color:#555">æ— é¢„è§ˆ</div>'
                      }
                  </div>
                  <div class="resource-list" id="files-\${song.id}">
                      <div class="btn-sel" onclick="toggleAll(this)">âœ… å…¨é€‰/åé€‰</div>\`;
          
          // æ›²ç»˜é€‰é¡¹
          if(song.ill) {
              const fn = song.ill.split('/').pop();
              html += \`<label class="file-item" data-url="\${BASE_URL}/\${song.ill}" data-name="\${fn}">
                  <input type="checkbox" checked><span class="tag tag-ill">æ›²ç»˜</span><span class="file-name">\${fn}</span>
              </label>\`;
          }
          // éŸ³é¢‘é€‰é¡¹
          if(song.aud) {
              const fn = song.aud.split('/').pop();
              html += \`<label class="file-item" data-url="\${BASE_URL}/\${song.aud}" data-name="\${fn}">
                  <input type="checkbox" checked><span class="tag tag-audio">éŸ³é¢‘</span><span class="file-name">\${fn}</span>
              </label>\`;
          }
          // è°±é¢é€‰é¡¹
          song.charts.forEach(c => {
              let diff = "";
              const up = c.name.toUpperCase();
              if(up.includes('EZ')) diff = '<span class="diff diff-EZ">EZ</span>';
              else if(up.includes('HD')) diff = '<span class="diff diff-HD">HD</span>';
              else if(up.includes('IN')) diff = '<span class="diff diff-IN">IN</span>';
              else if(up.includes('AT')) diff = '<span class="diff diff-AT">AT</span>';
              else if(up.includes('SP')) diff = '<span class="diff diff-SP">SP</span>';
              
              html += \`<label class="file-item" data-url="\${BASE_URL}/\${c.path}" data-name="\${c.name}">
                  <input type="checkbox" checked><span class="tag tag-chart">è°±é¢</span><span class="file-name">\${c.name}</span>\${diff}
              </label>\`;
          });
  
          html += \`</div></div></div>\`;
          return html;
      }).join('');
  }
  
  // æœç´¢åŠŸèƒ½
  document.getElementById('search').oninput = (e) => {
      const v = e.target.value.toLowerCase();
      document.querySelectorAll('.song-card').forEach(c => {
          c.style.display = c.dataset.id.includes(v) ? '' : 'none';
      });
  };
  
  // ç¯ç®±åŠŸèƒ½ (ç‚¹å‡»å›¾ç‰‡æ”¾å¤§)
  window.showLightbox = (url) => {
      if(!url || url.endsWith('/')) return;
      const lb = document.getElementById('lightbox');
      const img = document.getElementById('lb-img');
      img.src = url;
      lb.style.display = 'flex';
  };
  
  // å…¨é€‰/åé€‰
  window.toggleAll = (btn) => {
      const inputs = btn.parentElement.querySelectorAll('input');
      const all = Array.from(inputs).every(i => i.checked);
      inputs.forEach(i => i.checked = !all);
  };
  
  // å…³é—­ä¸‹è½½å¼¹çª—
  window.closeDlModal = () => {
      document.getElementById('dl-modal').style.display = 'none';
  };
  
  // === æ ¸å¿ƒï¼šå¸¦è¿›åº¦æ¡çš„ä¸‹è½½é€»è¾‘ ===
  window.startDownload = async (id) => {
      // 1. è·å–é€‰ä¸­çš„æ–‡ä»¶
      const container = document.getElementById('files-' + id);
      const items = Array.from(container.querySelectorAll('.file-item'))
          .filter(item => item.querySelector('input').checked)
          .map(item => ({
              url: item.dataset.url,
              name: item.dataset.name
          }));
  
      if(items.length === 0) return alert("è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªæ–‡ä»¶ï¼");
  
      // 2. å”¤èµ·è¿›åº¦æ¡å¼¹çª—
      const modal = document.getElementById('dl-modal');
      const pBar = document.getElementById('dl-progress');
      const pText = document.getElementById('dl-text');
      const closeBtn = document.getElementById('dl-close-btn');
      
      modal.style.display = 'flex';
      closeBtn.style.display = 'none'; // ä¸‹è½½ä¸­ç¦æ­¢å…³é—­
      pBar.style.width = '0%';
      pBar.style.background = 'linear-gradient(90deg, #238636, #2ea043)'; // æ¢å¤ç»¿è‰²
      
      try {
          const zip = new JSZip();
          const total = items.length;
          let count = 0;
  
          // 3. é€ä¸ªä¸‹è½½æ–‡ä»¶
          for(const item of items) {
              // æ›´æ–°UIï¼šæ˜¾ç¤ºå½“å‰ä¸‹è½½çš„æ–‡ä»¶å
              pText.innerHTML = \`æ­£åœ¨ä¸‹è½½ (\${count+1}/\${total}): <br><span style="color:#58a6ff">\${item.name}</span>\`;
              
              // è·å–æ–‡ä»¶
              const resp = await fetch(item.url);
              if(!resp.ok) throw new Error(\`ä¸‹è½½å¤±è´¥: \${item.name}\`);
              const blob = await resp.blob();
              
              // æ·»åŠ åˆ°Zip
              zip.file(item.name, blob);
              
              // æ›´æ–°è¿›åº¦æ¡
              count++;
              pBar.style.width = ((count / total) * 100) + '%';
          }
  
          // 4. å‹ç¼©æ‰“åŒ…
          pText.innerHTML = 'ğŸ“¦ æ­£åœ¨å‹ç¼©æ‰“åŒ…ï¼Œè¯·ç¨å€™...';
          const content = await zip.generateAsync({type:"blob"});
          
          // 5. è§¦å‘ä¸‹è½½
          const a = document.createElement('a');
          a.href = URL.createObjectURL(content);
          a.download = \`\${id}.zip\`;
          a.click();
  
          // 6. å®ŒæˆçŠ¶æ€
          pText.innerHTML = 'âœ… ä¸‹è½½å®Œæˆï¼å·²è‡ªåŠ¨ä¿å­˜';
          closeBtn.style.display = 'inline-block';
          
          // 3ç§’åè‡ªåŠ¨å…³é—­
          setTimeout(() => { if(modal.style.display !== 'none') closeDlModal(); }, 3000);
  
      } catch(e) {
          console.error(e);
          pText.innerHTML = \`âŒ å‘ç”Ÿé”™è¯¯: <br>\${e.message}\`;
          pBar.style.background = '#da3633'; // å˜çº¢
          closeBtn.style.display = 'inline-block';
      }
  };
  
  // å¯åŠ¨
  render();
  </script>
  </body>
  </html>
  EOF2
  
  rm "$TMP_JS"
  echo "âœ… å¢å¼ºç‰ˆä¸‹è½½ç«™ç”Ÿæˆå®Œæˆ"
