name: Update Zephyr Phigros Pages

on:
  workflow_run:
    workflows: ["Phigros Full Resources Final"]
    types: [completed]
  workflow_dispatch:

jobs:
  deploy-pages:
    runs-on: ubuntu-latest
    
    steps:
      - name: 1. æ£€å‡ºèµ„æºåº“
        uses: actions/checkout@v4
        with:
          repository: husbvt/Phigros_Resource_Build
          token: ${{ secrets.BUILD_PAT }}
          path: build_repo

      - name: 2. ç”Ÿæˆ Zephyr ä¸“å±ä¸‹è½½ç«™
        run: |
          # ä½¿ç”¨JSDelivr CDN
          BASE_URL="https://cdn.jsdelivr.net/gh/husbvt/Phigros_Resource_Build@master"
          
          # 1. åˆå§‹åŒ– HTML å¤´éƒ¨
          cat > index.html <<EOF
          <!DOCTYPE html>
          <html lang="zh-CN">
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>Zephyrçš„ä¸‹è½½ç«™</title>
              <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
              <style>
                  :root { --blue: #58a6ff; --bg: #0d1117; --card: #161b22; }
                  body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; background: var(--bg); color: #c9d1d9; margin: 0; padding: 15px; }
                  .container { max-width: 900px; margin: auto; }
                  h1 { color: var(--blue); text-align: center; margin-bottom: 30px; padding-top: 20px; }
                  .search-box { width: 100%; padding: 12px; background: var(--card); border: 1px solid #30363d; color: #fff; border-radius: 8px; margin-bottom: 20px; box-sizing: border-box; font-size: 16px; }
                  .search-box:focus { outline: none; border-color: #58a6ff; }
                  .song-card { background: var(--card); border: 1px solid #30363d; border-radius: 12px; margin-bottom: 25px; overflow: hidden; transition: transform 0.2s, box-shadow 0.2s; }
                  .song-card:hover { transform: translateY(-2px); box-shadow: 0 8px 16px rgba(0,0,0,0.3); }
                  .song-header { background: #21262d; padding: 15px; border-bottom: 1px solid #30363d; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px; }
                  .song-header span { font-size: 1.2em; font-weight: bold; color: #58a6ff; word-break: break-all; }
                  .song-content { display: flex; flex-direction: column; padding: 15px; gap: 20px; }
                  @media (min-width: 600px) { .song-content { flex-direction: row; } }
                  .preview-area { flex: 0 0 250px; }
                  .preview-img { width: 100%; height: 140px; object-fit: cover; border-radius: 8px; border: 1px solid #30363d; background: linear-gradient(45deg, #333, #444); transition: opacity 0.3s, transform 0.3s; opacity: 0; cursor: pointer; }
                  .preview-img:hover { transform: scale(1.02); }
                  .preview-img.loaded { opacity: 1; }
                  .resource-list { flex: 1; }
                  .file-item { display: flex; align-items: center; background: #0d1117; padding: 10px 12px; margin-bottom: 8px; border-radius: 6px; border: 1px solid #30363d; font-size: 14px; cursor: pointer; transition: background 0.2s; user-select: none; }
                  .file-item:hover { background: #21262d; border-color: #58a6ff; }
                  .checkbox { margin-right: 12px; width: 16px; height: 16px; cursor: pointer; flex-shrink: 0; }
                  .tag { font-size: 0.75em; padding: 3px 8px; border-radius: 4px; color: #fff; margin-right: 10px; font-weight: bold; min-width: 50px; text-align: center; flex-shrink: 0; }
                  .tag-audio { background: #1f6feb; }
                  .tag-chart { background: #238636; }
                  .tag-ill { background: #da3633; }
                  .btn-zip { background: #238636; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-weight: bold; transition: background 0.2s; font-size: 14px; }
                  .btn-zip:hover { background: #2ea043; }
                  .btn-zip:disabled { background: #30363d; cursor: not-allowed; opacity: 0.6; }
                  .btn-zip:active { transform: scale(0.98); }
                  .status { font-size: 0.85em; color: #8b949e; margin-right: 10px; }
                  .no-files { text-align: center; color: #8b949e; padding: 20px; font-style: italic; }
                  .select-all { margin: 10px 0 15px 0; font-size: 0.9em; color: #58a6ff; cursor: pointer; user-select: none; }
                  .select-all:hover { text-decoration: underline; }
                  .file-name { overflow: hidden; text-overflow: ellipsis; white-space: nowrap; flex: 1; }
                  .difficulty { font-size: 0.7em; padding: 1px 4px; border-radius: 3px; background: #30363d; color: #8b949e; margin-left: 5px; }
                  .difficulty-ez { background: #238636; color: #fff; }
                  .difficulty-hd { background: #da3633; color: #fff; }
                  .difficulty-in { background: #8957e5; color: #fff; }
                  .difficulty-at { background: #f0883e; color: #fff; }
                  .difficulty-sp { background: #9e6a03; color: #fff; }
                  .progress-bar { width: 100%; height: 4px; background: #30363d; border-radius: 2px; margin-top: 5px; overflow: hidden; display: none; }
                  .progress-fill { height: 100%; background: #238636; width: 0%; transition: width 0.3s; }
                  @media (max-width: 600px) {
                      .song-header { flex-direction: column; align-items: flex-start; }
                      .preview-area { flex: 0 0 180px; }
                      .preview-img { height: 120px; }
                  }
              </style>
          </head>
          <body>
              <div class="container">
                  <h1>ğŸµ Zephyrçš„Phigrosèµ„æºä¸‹è½½ç«™</h1>
                  <div style="text-align: center; margin-bottom: 20px; color: #8b949e; font-size: 0.9em;">
                      ä½¿ç”¨JSDelivr CDNï¼Œæ”¯æŒè·¨åŸŸä¸‹è½½
                  </div>
                  <input type="text" id="search" class="search-box" placeholder="æœç´¢æ­Œæ›²ID (ä¾‹å¦‚: é’èŠ½) æˆ–ç›´æ¥è¾“å…¥ID...">
                  <div id="list">
          EOF

          # 2. ç”Ÿæˆæ­Œæ›²å¡ç‰‡
          cd build_repo
          echo "è¿›å…¥build_repoç›®å½•"
          
          # è·å–æ‰€æœ‰æ­Œæ›²ID
          if [ -d "chart" ]; then
              SONG_IDS=$(find chart -type d -mindepth 1 -maxdepth 1 | sed 's|chart/||' | sort)
              echo "ä»chartç›®å½•æ‰¾åˆ°çš„æ­Œæ›²ID:"
              echo "$SONG_IDS" | head -20
          else
              SONG_IDS=""
          fi
          
          if [ -z "$SONG_IDS" ] && [ -d "music" ]; then
              SONG_IDS=$(find music -type f -name "*.mp3" -o -name "*.ogg" -o -name "*.wav" 2>/dev/null | \
                        xargs -I {} basename {} | \
                        sed 's/\.[^.]*$//; s/-[0-9]*$//' | \
                        sort -u)
          fi
          
          if [ -z "$SONG_IDS" ]; then
              echo "<div class='no-files'>ä»“åº“ä¸­æ²¡æœ‰æ‰¾åˆ°ä»»ä½•èµ„æºæ–‡ä»¶</div>" >> ../index.html
              cd ..
              cat >> index.html <<EOF
                  </div>
              </div>
              <script>console.log('æ²¡æœ‰æ‰¾åˆ°ä»»ä½•èµ„æºæ–‡ä»¶');</script>
          </body>
          </html>
          EOF
              exit 0
          fi
          
          # ä¸ºæ¯ä¸ªæ­Œæ›²IDç”Ÿæˆå¡ç‰‡
          SONG_COUNT=0
          for id in $SONG_IDS; do
              id_clean=$(echo "$id" | sed 's/\.[0-9]*$//')
              [ -z "$id_clean" ] && continue
              
              echo "å¤„ç†æ­Œæ›²ID: '$id_clean'"
              
              # æŸ¥æ‰¾æ–‡ä»¶
              ILL_FILES=$(find illustration -type f \( -name "${id}.*" -o -name "${id_clean}.*" \) 2>/dev/null)
              if [ -z "$ILL_FILES" ]; then
                  ILL_FILES=$(find illustration -type f -name "*${id_clean}*" 2>/dev/null)
              fi
              
              AUDIO_FILES=$(find music -type f \( -name "${id}.*" -o -name "${id_clean}.*" \) 2>/dev/null)
              
              CHART_FILES=""
              if [ -d "chart/${id}" ]; then
                  CHART_FILES=$(find "chart/${id}" -type f -name "*.json" 2>/dev/null)
              fi
              
              ILL_FILES_COUNT=$(echo "$ILL_FILES" | grep -v "^$" | wc -l)
              AUDIO_FILES_COUNT=$(echo "$AUDIO_FILES" | grep -v "^$" | wc -l)
              CHART_FILES_COUNT=$(echo "$CHART_FILES" | grep -v "^$" | wc -l)
              TOTAL_FILES=$((ILL_FILES_COUNT + AUDIO_FILES_COUNT + CHART_FILES_COUNT))
              
              if [ $TOTAL_FILES -eq 0 ]; then
                  continue
              fi
              
              SONG_COUNT=$((SONG_COUNT + 1))
              ILL_PREVIEW=$(echo "$ILL_FILES" | head -n1)
              
              # å¼€å§‹å†™å…¥å¡ç‰‡
              {
                echo "<div class='song-card' data-name='$id_clean'>"
                echo "<div class='song-header'>"
                echo "<span>$id_clean</span>"
                echo "<div style='display: flex; align-items: center;'>"
                echo "<span id='st-$id_clean' class='status'>$TOTAL_FILESä¸ªæ–‡ä»¶</span>"
                echo "<button class='btn-zip' onclick='pack(\"$id_clean\", this)' title='ä¸‹è½½é€‰ä¸­çš„æ–‡ä»¶'>ğŸ“¦ æ‰“åŒ…ä¸‹è½½</button>"
                echo "</div></div>"
                echo "<div class='song-content'>"
                
                # å›¾ç‰‡é¢„è§ˆ
                echo "<div class='preview-area'>"
                if [ ! -z "$ILL_PREVIEW" ] && [ -f "$ILL_PREVIEW" ]; then
                    ILL_URL="${BASE_URL}/${ILL_PREVIEW}"
                    ILL_URL_ENC=$(echo "$ILL_URL" | sed 's/ /%20/g; s/\[/%5B/g; s/\]/%5D/g; s/#/%23/g; s/&/%26/g')
                    echo "<img class='preview-img lazy' data-src='$ILL_URL_ENC' onclick='window.open(this.dataset.src)' alt='$id_clean æ›²ç»˜' loading='lazy'>"
                else
                    echo "<div style='height:140px;background:linear-gradient(135deg,#333,#555);border-radius:8px;display:flex;align-items:center;justify-content:center;color:#8b949e;'>æ— é¢„è§ˆ</div>"
                fi
                echo "</div>"
                
                # èµ„æºåˆ—è¡¨
                echo "<div class='resource-list'>"
                echo "<div class='select-all' onclick='toggleAll(\"$id_clean\")'>ğŸ“‹ å…¨é€‰/å–æ¶ˆå…¨é€‰</div>"
                echo "<div id='files-$id_clean'>"
                
                # æ›²ç»˜æ–‡ä»¶
                if [ $ILL_FILES_COUNT -gt 0 ]; then
                    echo "$ILL_FILES" | while read -r f; do
                        [ -z "$f" ] && continue
                        if [ -f "$f" ]; then
                            f_url="${BASE_URL}/${f}"
                            f_url_enc=$(echo "$f_url" | sed 's/ /%20/g; s/\[/%5B/g; s/\]/%5D/g; s/#/%23/g; s/&/%26/g')
                            f_name=$(basename "$f")
                            echo "<label class='file-item'><input type='checkbox' class='checkbox' data-url='$f_url_enc' data-name='$f_name' checked><span class='tag tag-ill'>æ›²ç»˜</span><span class='file-name'>$f_name</span></label>"
                        fi
                    done
                fi
                
                # éŸ³é¢‘æ–‡ä»¶
                if [ $AUDIO_FILES_COUNT -gt 0 ]; then
                    echo "$AUDIO_FILES" | while read -r f; do
                        [ -z "$f" ] && continue
                        if [ -f "$f" ]; then
                            f_url="${BASE_URL}/${f}"
                            f_url_enc=$(echo "$f_url" | sed 's/ /%20/g; s/\[/%5B/g; s/\]/%5D/g; s/#/%23/g; s/&/%26/g')
                            f_name=$(basename "$f")
                            echo "<label class='file-item'><input type='checkbox' class='checkbox' data-url='$f_url_enc' data-name='$f_name' checked><span class='tag tag-audio'>éŸ³é¢‘</span><span class='file-name'>$f_name</span></label>"
                        fi
                    done
                fi
                
                # è°±é¢æ–‡ä»¶
                if [ $CHART_FILES_COUNT -gt 0 ]; then
                    echo "$CHART_FILES" | while read -r f; do
                        [ -z "$f" ] && continue
                        if [ -f "$f" ]; then
                            f_url="${BASE_URL}/${f}"
                            f_url_enc=$(echo "$f_url" | sed 's/ /%20/g; s/\[/%5B/g; s/\]/%5D/g; s/#/%23/g; s/&/%26/g')
                            f_name=$(basename "$f")
                            
                            diff_class=""
                            diff_text=""
                            case "$f_name" in
                                *EZ*|*ez*|*Ez*) 
                                    diff_class="difficulty-ez"; diff_text="EZ" ;;
                                *HD*|*hd*|*Hd*) 
                                    diff_class="difficulty-hd"; diff_text="HD" ;;
                                *IN*|*in*|*In*) 
                                    diff_class="difficulty-in"; diff_text="IN" ;;
                                *AT*|*at*|*At*) 
                                    diff_class="difficulty-at"; diff_text="AT" ;;
                                *SP*|*sp*|*Sp*) 
                                    diff_class="difficulty-sp"; diff_text="SP" ;;
                            esac
                            
                            if [ ! -z "$diff_class" ]; then
                                echo "<label class='file-item'><input type='checkbox' class='checkbox' data-url='$f_url_enc' data-name='$f_name' checked><span class='tag tag-chart'>è°±é¢</span><span class='file-name'>$f_name</span><span class='difficulty $diff_class'>$diff_text</span></label>"
                            else
                                echo "<label class='file-item'><input type='checkbox' class='checkbox' data-url='$f_url_enc' data-name='$f_name' checked><span class='tag tag-chart'>è°±é¢</span><span class='file-name'>$f_name</span></label>"
                            fi
                        fi
                    done
                else
                    echo "<div style='color:#8b949e; font-size:0.9em; padding:5px;'>æš‚æ— è°±é¢æ–‡ä»¶</div>"
                fi
                
                echo "</div>"
                echo "<div class='progress-bar' id='progress-$id_clean'><div class='progress-fill' id='progress-fill-$id_clean'></div></div>"
                echo "</div></div></div>"
              } >> ../index.html
          done
          
          cd ..

          echo "æ€»å…±ç”Ÿæˆ $SONG_COUNT ä¸ªæ­Œæ›²å¡ç‰‡"
          
          if [ $SONG_COUNT -eq 0 ]; then
              echo "<div class='no-files'>ä»“åº“ä¸­æ²¡æœ‰æ‰¾åˆ°ä»»ä½•èµ„æºæ–‡ä»¶</div>" >> index.html
          fi

          # 3. å†™å…¥JSè„šæœ¬ - ç®€åŒ–è¯·æ±‚é¿å…é¢„æ£€
          cat >> index.html <<EOF
                  </div>
              </div>
              
              <script>
                  // å…¨å±€çŠ¶æ€ç®¡ç†
                  const downloadStates = {};
                  
                  // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
                  document.addEventListener('DOMContentLoaded', function() {
                      console.log('Zephyrä¸‹è½½ç«™å·²åŠ è½½');
                      initLazyLoad();
                      initSearch();
                      initCheckboxes();
                      initStatus();
                      
                      // æ˜¾ç¤ºä½¿ç”¨è¯´æ˜
                      console.log('ä½¿ç”¨è¯´æ˜ï¼š');
                      console.log('1. é€‰æ‹©è¦ä¸‹è½½çš„æ–‡ä»¶');
                      console.log('2. ç‚¹å‡»"æ‰“åŒ…ä¸‹è½½"æŒ‰é’®');
                      console.log('3. ç­‰å¾…ä¸‹è½½å®Œæˆ');
                  });
                  
                  function initLazyLoad() {
                      const imageObserver = new IntersectionObserver((entries, observer) => {
                          entries.forEach(entry => {
                              if (entry.isIntersecting) {
                                  const img = entry.target;
                                  if (img.dataset.src) {
                                      img.src = img.dataset.src;
                                      img.classList.add('loaded');
                                      observer.unobserve(img);
                                  }
                              }
                          });
                      }, { rootMargin: '200px', threshold: 0.1 });
                      
                      document.querySelectorAll('.preview-img.lazy').forEach(img => {
                          imageObserver.observe(img);
                      });
                  }
                  
                  function initSearch() {
                      const searchInput = document.getElementById('search');
                      searchInput.addEventListener('input', function() {
                          const searchTerm = this.value.toLowerCase().trim();
                          const cards = document.querySelectorAll('.song-card');
                          let visibleCount = 0;
                          
                          cards.forEach(card => {
                              const songId = card.dataset.name.toLowerCase();
                              const isMatch = songId.includes(searchTerm);
                              card.style.display = isMatch ? '' : 'none';
                              if (isMatch) visibleCount++;
                          });
                          
                          if (visibleCount === 0 && searchTerm) {
                              const listDiv = document.getElementById('list');
                              if (!listDiv.querySelector('.no-results')) {
                                  const noResults = document.createElement('div');
                                  noResults.className = 'no-files no-results';
                                  noResults.textContent = 'æœªæ‰¾åˆ°åŒ¹é…çš„æ­Œæ›²ID';
                                  listDiv.appendChild(noResults);
                              }
                          } else {
                              const noResults = document.querySelector('.no-results');
                              if (noResults) noResults.remove();
                          }
                      });
                      
                      searchInput.addEventListener('keydown', function(e) {
                          if (e.key === 'Escape') {
                              this.value = '';
                              this.dispatchEvent(new Event('input'));
                          }
                      });
                  }
                  
                  function initCheckboxes() {
                      document.querySelectorAll('.file-item').forEach(item => {
                          item.addEventListener('click', function(e) {
                              if (e.target.tagName === 'INPUT') return;
                              const checkbox = this.querySelector('input[type="checkbox"]');
                              if (checkbox) {
                                  checkbox.checked = !checkbox.checked;
                                  checkbox.dispatchEvent(new Event('change'));
                              }
                          });
                      });
                  }
                  
                  function initStatus() {
                      document.querySelectorAll('.song-card').forEach(card => {
                          const songId = card.dataset.name;
                          updateStatus(songId);
                      });
                  }
                  
                  function toggleAll(songId) {
                      const container = document.getElementById('files-' + songId);
                      if (!container) return;
                      
                      const checkboxes = container.querySelectorAll('.checkbox');
                      if (checkboxes.length === 0) return;
                      
                      const allChecked = Array.from(checkboxes).every(cb => cb.checked);
                      
                      checkboxes.forEach(cb => {
                          cb.checked = !allChecked;
                      });
                      
                      updateStatus(songId);
                  }
                  
                  function updateStatus(songId) {
                      const container = document.getElementById('files-' + songId);
                      if (!container) return;
                      
                      const checkboxes = container.querySelectorAll('.checkbox');
                      const checkedCount = Array.from(checkboxes).filter(cb => cb.checked).length;
                      const totalCount = checkboxes.length;
                      
                      const statusElem = document.getElementById('st-' + songId);
                      if (statusElem) {
                          statusElem.textContent = \`\${checkedCount}/\${totalCount}ä¸ªé€‰ä¸­\`;
                      }
                  }
                  
                  // ç®€åŒ–çš„fetchå‡½æ•°ï¼Œé¿å…è§¦å‘é¢„æ£€è¯·æ±‚
                  async function simpleFetch(url) {
                      console.log('ç®€å•è¯·æ±‚:', url);
                      
                      // ä½¿ç”¨æœ€ç®€å•çš„æ–¹å¼ï¼Œé¿å…ä»»ä½•å¯èƒ½è§¦å‘é¢„æ£€çš„å¤´éƒ¨
                      const response = await fetch(url, {
                          // ä¸ä½¿ç”¨ä»»ä½•è‡ªå®šä¹‰å¤´éƒ¨
                          // ä¸è®¾ç½®modeï¼ˆä½¿ç”¨é»˜è®¤å€¼ï¼‰
                          // ä¸è®¾ç½®credentials
                          // ä¸è®¾ç½®cacheæ§åˆ¶
                      });
                      
                      return response;
                  }
                  
                  // æ‰“åŒ…ä¸‹è½½æ ¸å¿ƒå‡½æ•°
                  async function pack(songId, button) {
                      console.log('å¼€å§‹æ‰“åŒ…ä¸‹è½½:', songId);
                      
                      const statusElem = document.getElementById('st-' + songId);
                      const progressBar = document.getElementById('progress-' + songId);
                      const progressFill = document.getElementById('progress-fill-' + songId);
                      
                      // é˜²æ­¢é‡å¤ç‚¹å‡»
                      if (downloadStates[songId] && downloadStates[songId].isDownloading) {
                          return;
                      }
                      
                      // è·å–é€‰ä¸­çš„æ–‡ä»¶
                      const container = document.getElementById('files-' + songId);
                      if (!container) {
                          alert('æœªæ‰¾åˆ°è¯¥æ­Œæ›²çš„èµ„æº');
                          return;
                      }
                      
                      const checkboxes = container.querySelectorAll('.checkbox:checked');
                      if (checkboxes.length === 0) {
                          alert('è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªæ–‡ä»¶');
                          return;
                      }
                      
                      console.log('æ‰¾åˆ°', checkboxes.length, 'ä¸ªé€‰ä¸­æ–‡ä»¶');
                      
                      // è®¾ç½®ä¸‹è½½çŠ¶æ€
                      downloadStates[songId] = { isDownloading: true, progress: 0 };
                      button.disabled = true;
                      button.innerHTML = 'â³ å¤„ç†ä¸­...';
                      progressBar.style.display = 'block';
                      progressFill.style.width = '0%';
                      
                      if (statusElem) {
                          statusElem.textContent = 'å‡†å¤‡ä¸‹è½½...';
                      }
                      
                      try {
                          const zip = new JSZip();
                          const totalFiles = checkboxes.length;
                          let processedFiles = 0;
                          let successCount = 0;
                          let failedFiles = [];
                          
                          // åˆ›å»ºæ–‡ä»¶ä¸‹è½½é˜Ÿåˆ—
                          const downloadQueue = Array.from(checkboxes).map(checkbox => ({
                              url: checkbox.dataset.url,
                              name: checkbox.dataset.name || checkbox.dataset.url.split('/').pop()
                          }));
                          
                          console.log('å¼€å§‹ä¸‹è½½æ–‡ä»¶...');
                          
                          // ä¾æ¬¡ä¸‹è½½æ¯ä¸ªæ–‡ä»¶
                          for (const fileInfo of downloadQueue) {
                              processedFiles++;
                              const progress = Math.round((processedFiles / totalFiles) * 100);
                              progressFill.style.width = progress + '%';
                              
                              if (statusElem) {
                                  statusElem.textContent = \`ä¸‹è½½ä¸­ (\${progress}%): \${fileInfo.name}\`;
                              }
                              
                              console.log(\`[\${processedFiles}/\${totalFiles}] ä¸‹è½½: \${fileInfo.name}\`);
                              
                              try {
                                  // æ·»åŠ æ—¶é—´æˆ³é¿å…ç¼“å­˜ï¼Œä½†æ”¾åœ¨URLä¸­è€Œä¸æ˜¯å¤´éƒ¨
                                  const cacheBustUrl = fileInfo.url + (fileInfo.url.includes('?') ? '&' : '?') + '_=' + Date.now();
                                  
                                  console.log('è¯·æ±‚URL:', cacheBustUrl);
                                  
                                  // ä½¿ç”¨ç®€åŒ–çš„fetchï¼Œé¿å…é¢„æ£€è¯·æ±‚
                                  const response = await simpleFetch(cacheBustUrl);
                                  
                                  console.log('å“åº”çŠ¶æ€:', response.status, response.statusText);
                                  
                                  if (!response.ok) {
                                      console.error('HTTPé”™è¯¯:', response.status, response.statusText);
                                      failedFiles.push({name: fileInfo.name, error: \`HTTP \${response.status}\`});
                                      continue;
                                  }
                                  
                                  const blob = await response.blob();
                                  console.log('æ–‡ä»¶å¤§å°:', blob.size, 'bytes');
                                  
                                  if (blob.size === 0) {
                                      console.warn('æ–‡ä»¶å¤§å°ä¸º0:', fileInfo.name);
                                      
                                      // å°è¯•ä½¿ç”¨imgæ ‡ç­¾ä¸‹è½½å›¾ç‰‡
                                      if (fileInfo.name.match(/\.(png|jpg|jpeg|gif)$/i)) {
                                          console.log('å°è¯•ä½¿ç”¨imgæ ‡ç­¾ä¸‹è½½å›¾ç‰‡...');
                                          try {
                                              const imgBlob = await downloadViaImage(fileInfo.url);
                                              if (imgBlob && imgBlob.size > 0) {
                                                  zip.file(fileInfo.name, imgBlob);
                                                  successCount++;
                                                  continue;
                                              }
                                          } catch (imgError) {
                                              console.log('imgæ ‡ç­¾ä¸‹è½½å¤±è´¥:', imgError);
                                          }
                                      }
                                      
                                      failedFiles.push({name: fileInfo.name, error: 'æ–‡ä»¶ä¸ºç©º'});
                                      continue;
                                  }
                                  
                                  // æ·»åŠ åˆ°ZIP
                                  zip.file(fileInfo.name, blob);
                                  successCount++;
                                  
                              } catch (fetchError) {
                                  console.error('ä¸‹è½½æ–‡ä»¶å¤±è´¥:', fileInfo.name, fetchError);
                                  failedFiles.push({name: fileInfo.name, error: fetchError.message});
                              }
                          }
                          
                          console.log('ä¸‹è½½å®Œæˆï¼ŒæˆåŠŸ:', successCount, 'å¤±è´¥:', failedFiles.length);
                          
                          if (successCount === 0) {
                              throw new Error('æ‰€æœ‰æ–‡ä»¶ä¸‹è½½éƒ½å¤±è´¥äº†');
                          }
                          
                          // ç”ŸæˆZIPæ–‡ä»¶
                          if (statusElem) {
                              statusElem.textContent = 'æ­£åœ¨ç”ŸæˆZIPæ–‡ä»¶...';
                          }
                          progressFill.style.width = '95%';
                          console.log('å¼€å§‹ç”ŸæˆZIPæ–‡ä»¶...');
                          
                          const zipBlob = await zip.generateAsync({
                              type: 'blob',
                              compression: 'DEFLATE',
                              compressionOptions: { level: 6 }
                          });
                          
                          console.log('ZIPæ–‡ä»¶å¤§å°:', zipBlob.size, 'bytes');
                          
                          if (zipBlob.size === 0) {
                              throw new Error('ç”Ÿæˆçš„ZIPæ–‡ä»¶ä¸ºç©º');
                          }
                          
                          // åˆ›å»ºä¸‹è½½é“¾æ¥
                          const downloadUrl = URL.createObjectURL(zipBlob);
                          const link = document.createElement('a');
                          link.href = downloadUrl;
                          link.download = \`\${songId}_resources_\${Date.now()}.zip\`;
                          link.style.display = 'none';
                          
                          // æ·»åŠ ç‚¹å‡»äº‹ä»¶æ¸…ç†
                          link.onclick = () => {
                              setTimeout(() => {
                                  document.body.removeChild(link);
                                  URL.revokeObjectURL(downloadUrl);
                              }, 100);
                          };
                          
                          document.body.appendChild(link);
                          
                          // è§¦å‘ä¸‹è½½
                          console.log('è§¦å‘ä¸‹è½½:', link.download);
                          link.click();
                          progressFill.style.width = '100%';
                          
                          // æ›´æ–°çŠ¶æ€
                          if (statusElem) {
                              let statusText = 'ä¸‹è½½å®Œæˆï¼';
                              if (failedFiles.length > 0) {
                                  statusText += \` (\${failedFiles.length}ä¸ªæ–‡ä»¶å¤±è´¥)\`;
                              }
                              statusElem.textContent = statusText;
                          }
                          button.innerHTML = 'âœ… å®Œæˆ';
                          
                          // æ˜¾ç¤ºå¤±è´¥æ–‡ä»¶ä¿¡æ¯
                          if (failedFiles.length > 0) {
                              setTimeout(() => {
                                  const failedList = failedFiles.map(f => \`\${f.name}: \${f.error}\`).join('\\n');
                                  alert(\`ä¸‹è½½å®Œæˆï¼Œä½†ä»¥ä¸‹æ–‡ä»¶ä¸‹è½½å¤±è´¥:\\n\\n\${failedList}\\n\\næˆåŠŸä¸‹è½½: \${successCount}ä¸ªæ–‡ä»¶\\nå¤±è´¥: \${failedFiles.length}ä¸ªæ–‡ä»¶\`);
                              }, 1000);
                          }
                          
                          // 3ç§’åæ¢å¤æŒ‰é’®çŠ¶æ€
                          setTimeout(() => {
                              button.disabled = false;
                              button.innerHTML = 'ğŸ“¦ æ‰“åŒ…ä¸‹è½½';
                              progressBar.style.display = 'none';
                              if (statusElem) {
                                  updateStatus(songId);
                              }
                              downloadStates[songId].isDownloading = false;
                          }, 3000);
                          
                      } catch (error) {
                          console.error('æ‰“åŒ…ä¸‹è½½å¤±è´¥:', error);
                          
                          if (statusElem) {
                              statusElem.textContent = 'ä¸‹è½½å¤±è´¥';
                          }
                          button.innerHTML = 'âŒ å¤±è´¥';
                          progressBar.style.display = 'none';
                          
                          let errorMsg = 'æ‰“åŒ…ä¸‹è½½å¤±è´¥';
                          if (error.message.includes('Failed to fetch') || error.message.includes('CORS')) {
                              errorMsg += 'ï¼šè·¨åŸŸè¯·æ±‚è¢«é˜»æ­¢ã€‚\\n\\nè§£å†³æ–¹æ¡ˆï¼š\\n1. å®‰è£…CORSæµè§ˆå™¨æ’ä»¶\\n2. æˆ–ç›´æ¥è®¿é—® https://husbvt.github.io/phigros.github.io/\\n3. æˆ–åœ¨GitHub PagesåŸŸåä¸‹ä½¿ç”¨';
                          } else if (error.message.includes('æ‰€æœ‰æ–‡ä»¶ä¸‹è½½éƒ½å¤±è´¥äº†')) {
                              errorMsg += 'ï¼šæ‰€æœ‰æ–‡ä»¶ä¸‹è½½éƒ½å¤±è´¥äº†ï¼Œå¯èƒ½æ˜¯ç½‘ç»œé—®é¢˜æˆ–èµ„æºæš‚æ—¶ä¸å¯ç”¨';
                          }
                          
                          alert(errorMsg + '\\n\\né”™è¯¯è¯¦æƒ…: ' + error.message);
                          
                          // 5ç§’åæ¢å¤æŒ‰é’®çŠ¶æ€
                          setTimeout(() => {
                              button.disabled = false;
                              button.innerHTML = 'ğŸ“¦ æ‰“åŒ…ä¸‹è½½';
                              if (statusElem) {
                                  updateStatus(songId);
                              }
                              downloadStates[songId].isDownloading = false;
                          }, 5000);
                      }
                  }
                  
                  // ä½¿ç”¨imgæ ‡ç­¾ä¸‹è½½å›¾ç‰‡çš„å¤‡é€‰æ–¹æ¡ˆ
                  function downloadViaImage(url) {
                      return new Promise((resolve, reject) => {
                          const img = new Image();
                          img.crossOrigin = 'Anonymous'; // é‡è¦ï¼šå…è®¸è·¨åŸŸ
                          
                          img.onload = function() {
                              const canvas = document.createElement('canvas');
                              canvas.width = img.width;
                              canvas.height = img.height;
                              
                              const ctx = canvas.getContext('2d');
                              ctx.drawImage(img, 0, 0);
                              
                              canvas.toBlob((blob) => {
                                  if (blob) {
                                      resolve(blob);
                                  } else {
                                      reject(new Error('æ— æ³•åˆ›å»ºBlob'));
                                  }
                              }, 'image/png');
                          };
                          
                          img.onerror = function(err) {
                              reject(new Error('å›¾ç‰‡åŠ è½½å¤±è´¥'));
                          };
                          
                          // è®¾ç½®è¶…æ—¶
                          setTimeout(() => {
                              reject(new Error('å›¾ç‰‡åŠ è½½è¶…æ—¶'));
                          }, 10000);
                          
                          img.src = url + (url.includes('?') ? '&' : '?') + 't=' + Date.now();
                      });
                  }
                  
                  // ç›‘å¬å¤é€‰æ¡†å˜åŒ–
                  document.addEventListener('change', function(e) {
                      if (e.target && e.target.classList.contains('checkbox')) {
                          const songId = e.target.closest('.song-card')?.dataset.name;
                          if (songId) {
                              updateStatus(songId);
                          }
                      }
                  });
                  
                  // é”®ç›˜å¿«æ·é”®
                  document.addEventListener('keydown', function(e) {
                      if (e.ctrlKey && e.key === 'f') {
                          e.preventDefault();
                          document.getElementById('search').focus();
                      }
                      
                      if (e.key === 'Escape') {
                          const searchInput = document.getElementById('search');
                          if (document.activeElement === searchInput) {
                              searchInput.value = '';
                              searchInput.dispatchEvent(new Event('input'));
                          }
                      }
                  });
                  
                  // æµ‹è¯•JSDelivrè¿æ¥
                  window.testConnection = async function() {
                      console.log('æµ‹è¯•JSDelivrè¿æ¥...');
                      const testUrl = 'https://cdn.jsdelivr.net/gh/husbvt/Phigros_Resource_Build@master/illustration/000AinSophAur.Yumeji.png';
                      
                      try {
                          // æµ‹è¯•ç®€å•è¯·æ±‚
                          console.log('æµ‹è¯•ç®€å•è¯·æ±‚...');
                          const response = await fetch(testUrl);
                          console.log('ç®€å•è¯·æ±‚ç»“æœ:', response.status, response.ok ? 'âœ“ æˆåŠŸ' : 'âœ— å¤±è´¥');
                          
                          // æµ‹è¯•å¸¦æ—¶é—´æˆ³çš„è¯·æ±‚
                          console.log('æµ‹è¯•å¸¦ç¼“å­˜æ¸…é™¤çš„è¯·æ±‚...');
                          const response2 = await fetch(testUrl + '?t=' + Date.now());
                          console.log('ç¼“å­˜æ¸…é™¤è¯·æ±‚ç»“æœ:', response2.status, response2.ok ? 'âœ“ æˆåŠŸ' : 'âœ— å¤±è´¥');
                          
                          return response.ok && response2.ok;
                      } catch (error) {
                          console.error('è¿æ¥æµ‹è¯•å¤±è´¥:', error);
                          return false;
                      }
                  };
                  
                  // é¡µé¢åŠ è½½åæ˜¾ç¤ºæç¤º
                  setTimeout(() => {
                      console.log('å¦‚æœä¸‹è½½å¤±è´¥ï¼Œè¯·å°è¯•ï¼š');
                      console.log('1. åˆ·æ–°é¡µé¢é‡è¯•');
                      console.log('2. åœ¨æ§åˆ¶å°è¾“å…¥ testConnection() æµ‹è¯•è¿æ¥');
                      console.log('3. ç›´æ¥è®¿é—® https://husbvt.github.io/phigros.github.io/');
                  }, 1000);
              </script>
          </body>
          </html>
          EOF

          echo "HTMLæ–‡ä»¶ç”Ÿæˆå®Œæˆ"

      - name: 3. éƒ¨ç½²åˆ°GitHub Pages
        env:
          AUTH_TOKEN: ${{ secrets.BUILD_PAT }}
        run: |
          echo "æ­£åœ¨éƒ¨ç½²åˆ°GitHub Pages..."
          
          git clone "https://${AUTH_TOKEN}@github.com/husbvt/phigros.github.io.git" pages_repo
          cp index.html pages_repo/
          
          cd pages_repo
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          if ! git diff --quiet index.html; then
              echo "æ£€æµ‹åˆ°index.htmlæœ‰å˜åŒ–ï¼Œæ­£åœ¨æäº¤..."
              git add index.html
              git commit -m "Zephyr: ç®€åŒ–è¯·æ±‚é¿å…CORSé¢„æ£€é—®é¢˜ $(date '+%Y-%m-%d %H:%M:%S')"
              git push origin master
              echo "éƒ¨ç½²æˆåŠŸï¼"
              
              echo "=== éƒ¨ç½²å®Œæˆ ==="
              echo "GitHub Pagesåœ°å€: https://husbvt.github.io/phigros.github.io/"
              echo ""
              echo "å¦‚æœä¸‹è½½ä»ç„¶å¤±è´¥ï¼š"
              echo "1. åœ¨æµè§ˆå™¨æ§åˆ¶å°è¾“å…¥ testConnection() æµ‹è¯•è¿æ¥"
              echo "2. å®‰è£…CORSæµè§ˆå™¨æ’ä»¶"
              echo "3. ç›´æ¥ä½¿ç”¨GitHub Pagesåœ°å€è®¿é—®"
          else
              echo "æ²¡æœ‰æ£€æµ‹åˆ°å˜åŒ–ï¼Œè·³è¿‡æäº¤ã€‚"
          fi
          
          cd ..
          rm -rf pages_repo build_repo
          echo "éƒ¨ç½²æµç¨‹å®Œæˆã€‚"
